#cloud-config 

#### cloud-init 23.4 (good for Fedora 40)

timezone: ${timezone}

hostname: ${hostname}
fqdn: ${fqdn}

manage_etc_hosts: true

users:
  - name: ansible
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    gecos: Ansible User
    groups: users,admin,wheel
    homedir: /home/ansible
    shell: /bin/bash
    lock_passwd: false
    ssh_authorized_keys:
      - ${public_key}

ssh_pwauth: true
disable_root: true

resize_rootfs: true

packages:
  - qemu-guest-agent
  - git
  - python3-pip
  - yq

package_update: true
package_upgrade: true
package_reboot_if_required: true


## Write yaml
write_files:
  - path: /home/ansible/vars.yml
    permissions: "0644"
    content: |
      ---
      global_helper_fqdn: ${fqdn}
      global_helper_hostname: ${hostname}
      global_domain: ${domain}
      global_network_cidr: ${network_cidr}
      global_master_details: 
        ${master_details}
      global_worker_details: 
        ${worker_details}
      global_bootstrap_details: 
        ${bootstrap_details}

## Ansible part
ansible:
  install_method: pip
  package_name: ansible
  #run_user only with install_method: pip
  run_user: ansible
  setup_controller:
    repositories:
      - path: /home/ansible/Okub
        source: https://github.com/MozeBaltyk/Okub.git
    run_ansible:
      - playbook_dir: /home/ansible/Okub
        playbook_name: ./playbooks/tasks/provision.yml
        extra_vars:
          vars_file: /home/ansible/vars.yml

bootcmd:
  - [ sh, -c, 'echo $(date) | sudo tee -a /root/bootcmd.log' ]

runcmd:
  - [ sh, -c, 'echo $(date) | sudo tee -a /root/runcmd.log' ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, qemu-guest-agent.service ]
  - [ systemctl, start, --no-block, qemu-guest-agent.service ]
  - [ domainname, ${domain} ]

final_message: "The system is finally up, after $UPTIME seconds"
