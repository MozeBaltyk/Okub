#cloud-config 

#### cloud-init 23.4 (good for Fedora 40)

timezone: ${timezone}

hostname: ${hostname}
fqdn: ${fqdn}

manage_etc_hosts: true

users:
  - name: ansible
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    gecos: Ansible User
    groups: users,admin,wheel
    homedir: /home/ansible
    shell: /bin/bash
    lock_passwd: false
    ssh_authorized_keys:
      - ${public_key}

ssh_pwauth: true
disable_root: true

resize_rootfs: true

packages:
  - qemu-guest-agent
  - git
  - python3-pip

package_update: true
package_upgrade: true

## Ansible part
ansible:
  install_method: pip
  package_name: ansible
  #run_user only with install_method: pip
  run_user: ansible
  setup_controller:
    repositories:
      - path: /home/ansible/Okub
        source: https://github.com/MozeBaltyk/Okub.git
    run_ansible:
      - playbook_dir: /home/ansible/Okub
        playbook_name: ./playbooks/tasks/provision.yml
        extra_vars: "${extra_vars}"

bootcmd:
  - [ sh, -c, 'echo $(date) | sudo tee -a /root/bootcmd.log' ]

runcmd:
  - [ sh, -c, 'echo $(date) | sudo tee -a /root/runcmd.log' ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, qemu-guest-agent.service ]
  - [ systemctl, start, --no-block, qemu-guest-agent.service ]
  - domainname ${domain}

final_message: "The system is finally up, after $UPTIME seconds"
